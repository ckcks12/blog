---
layout: post
title: My Kubernetes(EKS) Experience
title: ë‚˜ì˜ ì¿ ë²„ë„¤í‹°ìŠ¤(EKS) ê²½í—˜
author: Eunchan Lee
categories: [software,eks,kubernetes]
---

2ê°œì›”ì˜ ì¸í„´ ê¸°ê°„ë™ì•ˆ Terraform, AWS, Kubernetes ë¥¼ ê³µë¶€í•˜ë©´ì„œ ì¸í„´ ê¸°ê°„ì´ ëë‚˜ê°€ëŠ” ì§€ë„ ëª¨ë¥¸ì±„ ì´ê±° ì €ê±° ë°°í¬ ë“± ì¼ë§Œ í•˜ë‹¤ê°€ ì–´ì°Œ ì¢‹ê²Œ ë´ ì£¼ì…¨ëŠ”ì§€ ê°™ì´ ì¼í•  ê¸°íšŒë¥¼ ì£¼ì…¨ë‹¤.

ì¸í„´ê³¼ ì •ê·œì§ìœ¼ë¡œì„œì˜ ì—…ë¬´ ì°¨ì´ëŠ” ë”°ë¡œ ì—†ì—ˆë‹¤, ì–´ì œ í•˜ë˜ ë°°í¬ ì‘ì—… ì´ì–´ì„œ í–ˆë‹¤.

ì•„ë˜ëŠ” ë‚´ê°€ íšŒì‚¬ ì—…ë¬´ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤(EKS) ê´€ë ¨í•˜ì—¬ í–ˆë˜ ì—…ë¬´(ê²½í—˜)ë“¤ì´ë‹¤.

## ì¸í”„ë¼ ë¹„ìš© ì•„ë¼ê¸°
ìŠ¤íƒ€íŠ¸ì—… ë‹µì§€ ì•Šê²Œ? ë„‰ë„‰í•œ ìë³¸ì´ ìˆì–´ ì¸í”„ë¼ ìš”ê¸ˆì„ ì‹ ê²½ ì•ˆì“°ê³  ì‚¬ìš©í•˜ê³  ìˆì—ˆë‹¤

ê·¸ì¹˜ë§Œ ë„ˆë¬´ ë§ì´ ë‚˜ì˜¬ ë•ŒëŠ” í•œë²ˆì”© ì •ë¦¬ë¥¼ í•˜ê³¤ í–ˆë‹¤

ì¿ ë²  í´ëŸ¬ìŠ¤í„° ìì› í™œìš©ì„± ê°œì„ ì´ í•„ìš”í–ˆë‹¤

 ì¸ìŠ¤í„´ìŠ¤ ë‚®ì¶”ê³  ì•± resource ì™€ replica ì •ë¦¬í–ˆë‹¤

ìì› ì‚¬ìš©ëŸ‰ ì˜ˆìƒ ë° ì¸¡ì •ì„ ìœ„í•´ qos ë„ guarenteed ë¡œ í–ˆë‹¤

ê¸°ì¡´ì— ë‚˜ì™€ìˆëŠ” ë‹¤ë¥¸ íˆ´ë“¤ì—ì„œ limit ì„ ëª¨ì•„ì„œ ë³´ì—¬ì£¼ì§„ ì•Šì•„ì„œ

limit ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬í•˜ê¸° ìœ„í•´ì„œ ì§ì ‘ go ë¡œ í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ì–´ ê°„ë‹¨í•˜ê²Œ ê·¸ë˜í”„ë¥¼ ê·¸ë ¤ê°€ë©° ì‘ì—…í–ˆë‹¤

![img](https://i.imgur.com/t1W1h6f.png)

ìœ„ì—ì„œ ë³´ë“¯ì´ limit share ê°€ 46% ë„ ì•ˆì°¨ê³  ìˆë‹¤

cpu ëŠ” throttling ê±¸ë¦¬ì§€ë§Œ memory ëŠ” oom kill ì´ê¸° ë•Œë¬¸ì— memory ìœ„ì£¼ë¡œ ë³´ê²Œ ëë‹¤

![img](https://i.imgur.com/7hzFaMy.png)

ìš°ì„  resource request/limit ì¢€ ì •ë¦¬í–ˆë‹¤

ì•ŒíŒŒì—ì„œëŠ” ìš•ì‹¬ ë¶€ë¦¬ë˜ ì•±ì´ ë§ì•„ì„œ í˜¼ë‚´ì¤¬ê³  í”„ë¡œë•ì…˜ì—ì„œëŠ” replica ë§Œ ê±´ë“œë ¸ë‹¤

![img](https://i.imgur.com/bE6EL9O.png)

ì´ì œ ìì› í™œìš©ì„±ì´ 46% ì´í•˜ì¸ ë…¸ë“œëŠ” ì£½ì˜€ë‹¤ ê·¸ë˜ì„œ ì¤„ì¸ ê¸ˆì•¡ì€ ì•„ë˜ì™€ ê°™ë‹¤ (ì•ŒíŒŒê¸°ì¤€)

ì´ì „ : c5.xlarge(25) = $138 * 25 = $3456 (400ë§Œì›/ì›”)

ì´í›„ : m5.xlarge(6) = $169 * 6 = $1019 (115ë§Œì›/ì›”)

ì´ $2437(275ë§Œì›/ì›”) ì •ë„ ì•„ë¼ê²Œ ëë‹¤.

c ì—ì„œ m ìœ¼ë¡œ ê°„ ì´ìœ ëŠ”, ì•ŒíŒŒëŠ” cpu ë³´ë‹¨ memory ê°€ ë”í•„ìš”í•˜ë‹¤

ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ëŠ” ê·¸ë•Œë§ˆë‹¤ í•„ìš”í•œ ë…¸ë“œ ê·¸ë£¹ ë„ìš°ë©´ ëœë‹¤

ì•± ê°€ë™ ì‹œ ë” í° requirements ë¥¼ ê°–ëŠ” ê±´ memory ì´ê¸° ë•Œë¬¸ì´ë‹¤



## Kubernetes - kustomization as a Template Engine

ì§€ê¸ˆê¹Œì§€ ë‚´ ì†ìœ¼ë¡œ ë°°í¬í•œ ì•± ìˆ˜ëŠ” 27ê°œ, í•˜ë©´ì„œ ëŠë‚€ê²Œ kustomization í¸í–ˆëŠ”ë° í…œí”Œë¦¿ ê¸°ëŠ¥ì´ ë¶€ì¡±í–ˆë‹¤

kustomization 1.15 ë¥¼ helm ë§ˆëƒ¥ í…œí”Œë¦¿ìœ¼ë¡œ ì“°ë ¤ê³ 

`comonAnnotation` `var reference` ë“±ì„ í™œìš©í•´ë´¤ì§€ë§Œ

validation ë•Œ yaml attribute ëŠ” type ì´ ìˆê¸° ë•Œë¬¸ì— ì•ˆëœë‹¤..

ê·¸ëƒ¥ skeleton boilerplate ê°€ ë‚«ë‹¤ ğŸ˜…



## Kubernetes - istio envoy sidecar â†’ kiali

ì„œë¹„ìŠ¤ ë§¤ì‰¬ ê³µë¶€í•´ë³´ë©´ì„œ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í‚¹ì´ í•„ìš”í•˜ë‹¤ ìƒê°í–ˆë‹¤

istio sidecar ê°€ admission hook ì— ì•ˆë˜ì–´ ìˆì—ˆë‹¤ (np default ì—ë§Œ ì ìš©ë˜ì–´ìˆì—ˆë‹¤)

ê·¸ê±¸ ì˜ ëª°ë¼ì„œ ê·¸ëƒ¥ sidecar injection tool ì„ ì‚¬ìš©í–ˆë‹¤

ê·¸ëŸ°ë° ë§‰ ìƒì„±ëœ ì†ŒìŠ¤ê°€ ë„ˆë¬´ ë³µì¡ í–ˆê³  ë¬´ì—‡ë³´ë‹¤ ì˜¤ë¥˜ê°€ ì˜ë‚¬ë‹¤ ëë‹¤ê°€ ì•ˆëë‹¤ê°€..

ì´ìª½ì— ë” ë¦¬ì†ŒìŠ¤ ì“¸ ìˆ˜ ê°€ì—†ì–´ íŒ¨ìŠ¤í–ˆë‹¤


## Kubernetes - storage usage

ì–´ëŠ ë‚  ì•±ì´ ì˜ ì•ˆë– ì„œ event ë³´ê³  í–ˆë”ë‹ˆ inode ì–´ì©Œê³  í–ˆë‹¤

EBS ë³¼ë¥¨ í•˜ë“œì›¨ì–´ì ì¸ ë¬¸ì  ê°€? ì‹¬ê°í•œ í‘œì • ì§€ì—ˆëŠ”ë°

ê·¸ëƒ¥ docker image ê°€ ë¬´ê±°ìš´ê²Œ ë§ì´ ìŒ“ì—¬ì„œ ê·¸ëŸ°ê±°ë€ë‹¤

20G â†’ 50G ë¡œ ëŠ˜ë ¤ì„œ í•´ê²°ëë‹¤



## Kubernetes - IRSA

ì¿ ë²  ì•±ì€ aws sdk ì“¸ ë•Œ AWS ACCESS KEY ë¥¼ ì“°ì§€ ì•Šê³ 

ë” ë³´ì•ˆì ìœ¼ë¡œ ì•ˆì „í•˜ê³  ê°œë°œí•˜ê¸°ì—ë„ í¸ë¦¬í•´ì„œ ì‚¬ìš©í•˜ê²Œ ëë‹¤

aws sdk ì¸ì¦ ìš°ì„ ìˆœìœ„ ì¤‘ì—ì„œ ê±°ì˜ ë§¨ë§ˆì§€ë§‰ì— ìˆëŠ” web token ë°©ì‹ì´ë‹¤

aws iam role ì„ ë§Œë“¤ê³  í•´ë‹¹ arn ì„ service account ì˜ annotation ì— ë‹¬ë©´

operator ê°€ token ë°›ì•„ì™€ file ë¡œ ë§ˆìš´íŠ¸í•´ì¤€ë‹¤ + í™˜ê²½ë³€ìˆ˜ë„

ì´ë•Œ ì´ file ì„ ë¡œì»¬ì— ê°€ì ¸ì˜¤ë©´ ë””ë²„ê¹…ë„ ê°€ëŠ¥í•˜ë‹¤ ğŸ¤«


## Kubernetes - Logging Operator

fluentd ë¥¼ ì˜¬ë ¤ì•¼í•´ì„œ ì´ë¥¼ operator ë¡œ ì˜ ë§Œë“¤ì–´ë‘” logging operator ë¥¼ ì“°ë ¤ í–ˆë‹¤

í•˜ì§€ë§Œ ë””ë²„ê¹…ë„ ì˜ ì•ˆë˜ê³  ë­”ê°€ ì•ˆë˜ëŠ”ê²Œ ë§ì•˜ë‹¤

ìš©ê°í•˜ê²Œ ì†ŒìŠ¤ë¥¼ ê¹Œë´¤ë‹¤, ì†ŒìŠ¤ ê¹Œë³´ëŠ”ê²Œ ì œì¼ ì¢‹ì•˜ë‹¤, Go ë¼ì„œ ì½ê¸° ì‰¬ì› ë‹¤

file output ì—ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë„ ì—†ê³  plugin ì„¤ì¹˜ì— ëŒ€í•œ í™•ì¥ ìœ ì—°ì„±ì´ ë–¨ì–´ì¡Œë‹¤

ì§ì ‘ docker ë¡œ êµ½ê¸°ì—” ë¶€ë‹´ ëë‹¤

ì‚¬ìš©ì„ ì² íšŒí•˜ê³  ì§ì ‘ daemonset ìœ¼ë¡œ fluentd forwarder ì˜¬ë ¸ë‹¤


## Kubernetes - External Secrets Hang ë²„ê·¸

gitops ì´ê¸°ì— secret ë“¤ì„ yaml ë¡œ ì˜¬ë¦´ ìˆ˜ ì—†ì—ˆë‹¤

aws ì˜ ssm parameter store ë¥¼ í™œìš©í–ˆë‹¤

godaddy ì˜ external secrets ì„ ì‚¬ìš©í–ˆëŠ”ë° ë¬¸ì œê°€ ìˆì—ˆë‹¤

í•œë‹¬ ë°˜ ì •ë„ ì§€ë‚˜ë©´ ê°‘ìê¸° hang ê±¸ë ¤ì„œ ì‘ë™í•˜ì§€ ì•Šì•˜ë‹¤

ìš©ê°í•˜ê²Œ ë˜ ì†ŒìŠ¤ë¥¼ ê¹Œë´¤ëŠ”ë°

ì¿ ë²  ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ íŒŒì´í”„ë¡œ ì—°ê²°í•´ì„œ ë¦¬ìŠ¤ë‹í•  ë•Œ deathQueue ì—ê¹Œì§€ ë„ë‹¬ ëª»í•˜ëŠ” ê²ƒ ê°™ì•˜ë‹¤

`error` ì™€ `end` event ì—ì„œë§Œ deathQueue ì— enqueue í•˜ëŠ”ë°

ì € ë‘ event ëŠ” í˜¸ì¶œë˜ì§€ ì•Šì§€ë§Œ ì¿ ë²  stream ì´ ì‘ë™ì•ˆí•˜ëŠ” í–‰ê±¸ë¦° ìƒíƒœ..

ê·¸ëƒ¥ event ìƒˆë¡œ íŒŒë„ ì¢‹ìœ¼ë‹ˆ ì¢€ ìì£¼ íŒŒë©´ ì¢‹ì•˜ì„ ê²ƒ ê°™ë‹¤ ğŸ˜³

ê·¸ë˜ì„œ ê·¸ëƒ¥ ì‘ë™ì•ˆí•  ë•Œë§ˆë‹¤ ì¬ì‹œì‘í–ˆë‹¤


```js
try {
    while (true) {
      logger.debug('Starting watch stream')

      const stream = kubeClient
        .apis[customResourceManifest.spec.group]
        .v1.watch[customResourceManifest.spec.names.plural]
        .getStream()

      const jsonStream = new JSONStream()
      stream.pipe(jsonStream)

      jsonStream.on('data', eventQueue.put)

      jsonStream.on('error', (err) => {
        logger.warn(err, 'Got error on stream')
        deathQueue.put('ERROR')
      })

      jsonStream.on('end', () => {
        deathQueue.put('END')
      })

      await deathQueue.take()

      logger.debug('Stopping watch stream')
      eventQueue.put({ type: 'DELETED_ALL' })

      stream.abort()
    }
  } catch (err) {
    logger.error(err, 'Watcher crashed')
  }
}
```


## Kubernetes - External Secrets SSM ë³€ê²½ì‚¬í•­ ìë™ ë°˜ì˜

AWS SSM Parameter Store ì—ì„œ ê°’ì„ ë°”ê¾¸ì–´ë„ ì¿ ë² ì—” ë°˜ì˜ë˜ì§€ ì•Šì•˜ë‹¤

sns ë¡œ ë¦¬ìŠ¤ë‹í•˜ê³  ê´€ë ¨ëœ key ê°’ì´ ìˆëŠ” CRD ë¥¼ retouch í•´ì£¼ë©´ ë  ê²ƒ ê°™ë‹¤


## AWS - Elasticache Redis Memory Usage Percentage

ë ˆë””ìŠ¤ ë‚¨ì€ ë©”ëª¨ë¦¬ ìš©ëŸ‰ì€ CWì˜ Freeable Memory ì§€í‘œë¡œëŠ” ëª»ê°€ì ¸ì˜¨ë‹¤ (ë¶€ì •í™•í•¨

ì´ë¥¼ ìœ„í•´ Datadog Agent ë¥¼ ë”°ë¡œ ì—°ê²°í•˜ì—¬ ê³„ì‚°í•˜ê³  ê·¸ë¬ë‹¤

ê·¸ ì‘ì—…ì„ í•œì§€ ì´í‹€ë§Œì—”ê°€ AWS ì—ì„œ ìƒˆë¡œìš´ ì§€í‘œë¥¼ ì§€ì›í•´ì¤¬ë‹¤ ğŸ¤¯

ê³„ì† ë³€í•˜ëŠ” AWS , ê³„ì† ê³µë¶€í•´ì•¼í•œë‹¤
